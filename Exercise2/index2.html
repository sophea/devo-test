<!DOCTYPE html>
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<body>
<canvas id="myChart" style="width:100%;max-width:600px"></canvas>

<script>

  var COLORS = [
    '#4dc9f6',
    '#f67019',
    '#f53794',
    '#537bc4',
    '#acc236',
    '#166a8f',
    '#00a950',
    '#58595b',
    '#8549ba'
  ];

  /**MyObject to all datasource*/
  function MyObject(cat, d, value) {
    this.cat = cat;
    this.d = d; // date value
    this.value = value;
  };

  /**format date*/
  function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2)
      month = '0' + month;
    if (day.length < 2)
      day = '0' + day;

    return [year, month, day].join('-');
  }

  var myObjects = []

  var value ="CcoeoNR8 T4VSBd0GC fpAepuTD 5A40zJ6 y5bXBb rRxM 2015-06-08 J KA9FicdV BSbvirf #CAT 2#"
  date_regex = "\d{4}\-(0?[1-9]|1[012])\-(0?[1-9]|[12][0-9]|3[01])";
 // var result =date_regex.test(value);
  //console.log("date_regex " + result)

  function parseRawToDate(value) {
    result = value.split(/\d{4}-\d{2}-\d{2}/);
    var yyyyMMdd=''
    for(const item of result) {
      yyyyMMdd = value.replace(item,'')
      value = yyyyMMdd
   //   console.log(yyyyMMdd)
    }
    return yyyyMMdd;
  }

 // parseRawToDate(value)

  function parseRawCat(value) {
    result = value.split(/#/);
    for (const item of result) {
      if (item.startsWith("CAT")) {
        return item;
      }
     // console.log(item)
    }

  }
//  var cat = parseRawCat(value)
//  console.log("CAT ====="  + cat)

  function getDS3(url) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", url, false);

    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == 4 && xhttp.status == 200) {
        var datapoints = JSON.parse(xhttp.responseText);
        //  console.log("DS2 " + datapoints)
        ds3= datapoints.map(function(item) {
          return new MyObject(parseRawCat(item.raw), parseRawToDate(item.raw), item.val);

        });
        myObjects.push(ds3);

      }
    }
    xhttp.send();
  }

  function getDS2(url) {
    var xhttp2 = new XMLHttpRequest();
    xhttp2.open("GET", url, false);

    xhttp2.onreadystatechange = function () {
      if (xhttp2.readyState == 4 && xhttp2.status == 200) {
        var datapoints = JSON.parse(xhttp2.responseText);
      //  console.log("DS2 " + datapoints)
        ds2= datapoints.map(function(item) {
          return new MyObject(item.categ, item.myDate, item.val);

        });
        myObjects.push(ds2);

      }
    }
    xhttp2.send();
  }

  //// ###### push data source 1 ###########
    url = "http://s3.amazonaws.com/logtrust-static/test/test/data1.json";
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", url);


    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
         datapoints = JSON.parse(this.responseText);

         ds1= datapoints.map(function(item) {
           return new MyObject(item.cat, formatDate(new Date(item.d)), item.value);
          });

       myObjects.push(ds1);


        getDS2("http://s3.amazonaws.com/logtrust-static/test/test/data2.json");

        getDS3("https://s3.amazonaws.com/logtrust-static/test/test/data3.json")

        console.log("=====myObjects length " + myObjects.length)

        //date
        var dv = datapoints.map(function(item) {
          return formatDate(new Date(item.d));
        });
        console.log("=======dateValuess======")
        var dateValues = [];
        for (const element of dv) { // Y
          if(dateValues.indexOf(element) == -1) {
            dateValues.push(element);
          }
        }

        //console.log(datapoints);
        label =  datapoints.map(function(item) {
          return item.cat;
        });
      //  console.log(label);
        var categories = []
        for (const element of label) { // You can use `let` instead of `const` if you like
          //console.log(element.toUpperCase());
          const v = element.toUpperCase();
          if(categories.indexOf(v) == -1) {
            categories.push(v);
          }
        }
        console.log(categories);


        function getValueByCat(cat, myObjects) {

          var catObjects = []
          for (const item of myObjects) {
            const v = item.cat.toUpperCase();
            if (v == cat) {
              catObjects.push(item);
            }
          }
          //date
          // var dateValues2 = cat2Objects.map(function(item) {
          //   return formatDate(new Date(item.d));
          // });
          //console.log("cat " + labelCat)
          // date
          values = catObjects.map(function (item){
            return item.value
          })
          return values;
        }
        ////////////////////////////////////////CAT2######

        // var cat2Objects = []
        // for (const item of myObjects) {
        //   const v = item.cat.toUpperCase();
        //   if (v == 'CAT 2') {
        //     cat2Objects.push(item);
        //   }
        // }
        // //date
        // var dateValues2 = cat2Objects.map(function(item) {
        //   return formatDate(new Date(item.d));
        // });
        // //console.log("cat " + labelCat)
        // // date
        // values2 = cat2Objects.map(function (item){
        //   return item.value
        // })

        ////////////Chart Object
        var chart = new Chart("myChart", {
          type: "line",
          data: {
            labels: dateValues,
            datasets: [
            //     {
            //   label: 'CAT 1',
            //   data: values,
            //   borderColor: "red",
            //   fill: false
            // },
            // {
            //   label: 'CAT 2',
            //   data: values2,
            //   borderColor: "green",
            //   fill: false
            // }
            ]
          },
          options: {
            legend: {display: true},
            text: "Testing",
          }
        });

        console.log("====myObjects : " + myObjects.length)

        // var items =[]
        // for (const myObject of myObjects) {
        //   items.push(myObject)
        //   console.log("xxxxx" + myObject.length)
        // }
        //
        // console.log("====items : " + items[0].length)

        var index =0;
       for (const myObject of myObjects) {

          console.log("xxxxx" + index + myObject)

          for (const cat of categories) {
            var values = getValueByCat(cat, myObject);
            var object1 = {
              label: cat,
              data: values,
              borderColor: COLORS[index++],
              fill: false
            }
            chart.data.datasets.push(object1);
          }
       }


        chart.update()
      }
    };

  xhttp.send();



</script>
